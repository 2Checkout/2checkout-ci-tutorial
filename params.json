{"name":"2Checkout PHP Tutorial","body":"## 2Checkout CodeIgniter Integration Tutorial\r\n----------------------------------------\r\n\r\nIn this tutorial we will walk through integrating the 2Checkout payment method into an existing user management application built on CodeIgniter Bootstrap (CodeIgniter 2.1.2, TwitterBootstrap 2.1.0). This demo application also utilizes the ion_auth user authentication library. The source for the example application used in this tutorial can be accessed in this Github repository.\r\n\r\nSetting up the Example Application\r\n----------------------------------\r\n\r\nWe need an existing example application to demonstrate the integration so lets download or clone the 2checkout-ci-example application.\r\n\r\n```shell\r\n$ git clone https://github.com/2checkout/2checkout-ci-tutorial.git\r\n```\r\n\r\nThis repository contains both an example before and after application so that we can follow along with the tutorial using the site\\_before app and compare the result with the site\\_after app. We can start by moving the site\\_before directory to the webroot directory on our server and let rename it to web-widgets which is the name of our site.\r\n\r\nNow we need to create our database.\r\n\r\n```shell\r\ncreate database webwidgets;\r\n```\r\n\r\nNext we run the mysql_database.sql file on our database.\r\n\r\n```shell\r\nmysql webwidgets < mysql_database.sql -u <mysql username> -p\r\n```\r\n\r\nNow we can specify our database credentials in our application.\r\n\r\napplication/config/database.php\r\n\r\n```php\r\n$db['default']['hostname'] = 'localhost';\r\n$db['default']['username'] = 'your mysql username';\r\n$db['default']['password'] = 'your mysql password';\r\n$db['default']['database'] = 'webwidgets';\r\n$db['default']['dbdriver'] = 'mysql';\r\n```\r\n\r\nWe can then view the example application at [http://localhost/web-widgets/index.php](http://localhost/web-widgets/index.php).\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-1.png)\r\n\r\nYou can see that this site requires users to signup for a membership to access the web-widget content pages. Once logged in, they can also manage their user account, but do not have access to the admin functions.\r\n\r\nIn this tutorial, we will integrate the 2Checkout payment method so that the user must order a recurring monthly membership before gaining access to the contect. We will also setup a listener that will be responsible for updating the users access to the contact based on the Notifications that 2Checkout sends on their recurring billing status and provide the user with the ability to update their billing information and cancel their recurring membership.\r\n\r\nSetting up the 2Checkout PHP Library\r\n------------------------------------\r\n2Checkouts a PHP library provides us with a simple bindings to the API, INS and Checkout process so that we can integrate each feature with only a few lines of code. We can download or clone the library at [https://github.com/2checkout/2checkout-php](https://github.com/2checkout/2checkout-php).\r\n\r\nIncluding the library is as easy as copying contents of the **lib** directory to \"application/libraries\" and then we can require the library where we want it in our application. In our case, we will be working with the **order** controller so in \"application/contollers/order.php\" we will require the Twocheckout.php abstract class in the constructor.\r\n\r\n```php\r\n<?php\r\n\r\nrequire_once(APPPATH . 'libraries/Twocheckout.php');\r\n```\r\n\r\nKnow we have access to all of the 2Checkout bindings and are ready to integrate.\r\n\r\nCheckout\r\n--------\r\nCurrently we are activating users automatically. So lets go ahead and turn automatic activation off in the ion_auth.php configuration file by setting the manual\\_activation option to true.\r\n\r\n```php\r\n<?php\r\n\r\n$config['manual_activation']    = TRUE;\r\n```\r\n\r\nNow, lets take a look at our register function.\r\n\r\n```php\r\n<?php\r\n\r\n    public function register()\r\n    {\r\n        //validate form input\r\n        $this->form_validation->set_rules('first_name', 'First Name', 'required|xss_clean');\r\n        $this->form_validation->set_rules('last_name', 'Last Name', 'required|xss_clean');\r\n        $this->form_validation->set_rules('email', 'Email Address', 'required|valid_email');\r\n        $this->form_validation->set_rules('password', 'Password', 'required|min_length[' . $this->config->item('min_password_length', 'ion_auth') . ']|max_length[' . $this->config->item('max_password_length', 'ion_auth') . ']|matches[password_confirm]');\r\n        $this->form_validation->set_rules('password_confirm', 'Password Confirmation', 'required');\r\n\r\n        if ($this->form_validation->run() == true)\r\n        {\r\n            $username = strtolower($this->input->post('first_name')) . ' ' . strtolower($this->input->post('last_name'));\r\n            $email    = $this->input->post('email');\r\n            $password = $this->input->post('password');\r\n\r\n            $additional_data = array(\r\n                'first_name' => $this->input->post('first_name'),\r\n                'last_name'  => $this->input->post('last_name'),\r\n            );\r\n        }\r\n        if ($this->form_validation->run() == true && $this->ion_auth->register($username, $password, $email, $additional_data))\r\n        {\r\n            //check to see if we are creating the user\r\n            $this->session->set_flashdata('message', $this->ion_auth->messages());\r\n\r\n            //redirect to login\r\n            redirect('auth/login', 'refresh');\r\n        }\r\n        else\r\n        {\r\n            //display the create user form\r\n            //set the flash data error message if there is one\r\n            $this->data['message'] = (validation_errors() ? validation_errors() : ($this->ion_auth->errors() ? $this->ion_auth->errors() : $this->session->flashdata('message')));\r\n\r\n            $this->data['first_name'] = array(\r\n                'name'  => 'first_name',\r\n                'id'    => 'first_name',\r\n                'type'  => 'text',\r\n                'value' => $this->form_validation->set_value('first_name'),\r\n            );\r\n            $this->data['last_name'] = array(\r\n                'name'  => 'last_name',\r\n                'id'    => 'last_name',\r\n                'type'  => 'text',\r\n                'value' => $this->form_validation->set_value('last_name'),\r\n            );\r\n            $this->data['email'] = array(\r\n                'name'  => 'email',\r\n                'id'    => 'email',\r\n                'type'  => 'text',\r\n                'value' => $this->form_validation->set_value('email'),\r\n            );\r\n            $this->data['password'] = array(\r\n                'name'  => 'password',\r\n                'id'    => 'password',\r\n                'type'  => 'password',\r\n                'value' => $this->form_validation->set_value('password'),\r\n            );\r\n            $this->data['password_confirm'] = array(\r\n                'name'  => 'password_confirm',\r\n                'id'    => 'password_confirm',\r\n                'type'  => 'password',\r\n                'value' => $this->form_validation->set_value('password_confirm'),\r\n            );\r\n        }\r\n\r\n        $this->load->view('/include/header');\r\n        $this->load->view('/include/navblank');\r\n        $this->load->view('/order/register', $this->data);\r\n        $this->load->view('/include/footer');\r\n    }\r\n```\r\n\r\nAs you can see, we are currently setting up the registration form fields, checking the field validation and if the user input passes validation, we register the user ad redirect to the login page. Since we are now requiring a manual activation, we want to pass the user to 2Checkout to pay for the membership before we activate them. To accomplish this, we will remove the login redirect, get the user id from the database and utilize the `Twocheckout::Charge::redirect` binding.\r\n\r\n```php\r\n<?php\r\n\r\n    //get user id\r\n    $query = $this->db->query(\"SELECT * FROM users WHERE email = '$email'\");\r\n    $row = $query->row();\r\n    $id = $row->id;\r\n\r\n    //setup the checkout parameters\r\n    $args = array(\r\n        'sid' => 1817037,\r\n        'mode' => \"2CO\",\r\n        'li_0_name' => \"Monthly Subscription\",\r\n        'li_0_price' => \"1.00\",\r\n        'li_0_recurrence' => \"1 Month\",\r\n        'merchant_order_id' => $id\r\n    );\r\n\r\n    //pass the buyer and the parameters to the checkout\r\n    Twocheckout_Charge::redirect($args);\r\n```\r\n\r\nLets take a look at what we did here. First we grabbed the the id for this user from the database and assigned it to the `$id` variable.\r\n\r\nThen we create an array of sale parameters to pass to 2Checkout using the [Pass-Through-Products](https://www.2checkout.com/blog/knowledge-base/merchants/tech-support/3rd-party-carts/parameter-sets/pass-through-product-parameter-set/) parameter set and we assign the `$id` to the `merchant_order_id` parameter. _(The value passed with the `merchant_order_id parameter` will be passed back to our approved URL and will be returned using the `vendor_order_id` parameter on all INS messages pertaining to the sale.)_\r\n\r\nThen we pass the parameters and the buyer to our custom checkout page on 2Checkout's secure server to complete the order.\r\n\r\nPassback\r\n--------\r\n\r\nWhen the order is completed, 2Checkout will return the buyer and the sale parameters to the URL that we specify as the approved URL in our account. This URL can also be passed in dynamically for each sale using the `x_receipt_link_url` parameter.\r\n\r\nBefore we have a route for the approved URL, we will need to create our passback function in the order controller.\r\n\r\n```php\r\n<?php\r\n\r\n    public function passback()\r\n    {\r\n        //Assign the returned parameters to an array.\r\n        $params = array();\r\n        foreach ($_REQUEST as $k => $v) {\r\n            $params[$k] = $v;\r\n        }\r\n\r\n        //Check the MD5 Hash to determine the validity of the sale.\r\n        $passback = Twocheckout_Return::check($params, \"tango\", 'array');\r\n\r\n        if ($passback['code'] == 'Success') {\r\n            $id = $params['merchant_order_id'];\r\n            $order_number = $params['order_number'];\r\n            $invoice_id = $params['invoice_id'];\r\n            $data = array(\r\n                'active' => 1,\r\n                'order_number' => $order_number,\r\n                'last_invoice' => $invoice_id\r\n                );\r\n            $this->ion_auth->update($id, $data);\r\n\r\n            $this->load->view('/include/header');\r\n            $this->load->view('/include/navblank');\r\n            $this->load->view('/order/return_success');\r\n            $this->load->view('/include/footer');\r\n        } else {\r\n            $this->load->view('/include/header');\r\n            $this->load->view('/include/navblank');\r\n            $this->load->view('/order/return_failed');\r\n            $this->load->view('/include/footer');\r\n        }\r\n    }\r\n```\r\n\r\nFirst we grab all of the parameters returned by 2Checkout and assign the to the `params` array that we created.\r\n\r\nThen we pass the array and our secret word to the `Twocheckout::Return` binding and check the response. _(Twocheckout bindings return JSON by default or you can pass an optional third argument 'array' to return the response in an array.)_\r\n\r\n If the response if successful `$response['code'] == \"Success\"`, we activate the user and display the order success page. If the response is not successful `$response['code`] == \"Fail\"`, we display the order failed page.\r\n\r\nNow we can setup our return method, enter our secret word and provide the approved URL path \"http://localhost/web-widgets/index.php/order/passback\" under the Site Management page in our 2Checkout admin.\r\n\r\n**Site Management Page**\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-3.png)\r\n\r\n**Lets try it out with a live sale.**\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-2.png)\r\n\r\n**Enter in our billing information.**\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-4.png)\r\n\r\n**Submit the payment.**\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-5.png)\r\n\r\nNow the user is activated and can login to access the content that they paid for.\r\n\r\nNotifications\r\n-------------\r\n\r\n2Checkout will send notifications to our application under the following circumstances.\r\n\r\n* Order Created\r\n* Fraud Status Changed\r\n* Shipping Status Changed\r\n* Invoice Status Changed\r\n* Refund Issued\r\n* Recurring Installment Success\r\n* Recurring Installment Failed\r\n* Recurring Stopped\r\n* Recurring Complete\r\n* Recurring Restarted\r\n\r\nFor our application, we are interested in the Fraud Status Changed message to disbale the user if the sale fails fraud review, Recurring Installment Failed to disable the user if their billing fails to bill successfully, and the Recurring Installment Success message to re-enable a disbaled user.\r\n\r\nWe are going to setup our notification function under our order controller.\r\n\r\n```php\r\n<?php\r\n\r\npublic function notification()\r\n{\r\n    //Assign the returned parameters to an array\r\n    $params = array();\r\n    foreach ($_POST as $k => $v) {\r\n        $params[$k] = $v;\r\n    }\r\n    //Check the MD5 Hash to determine the validity of the message\r\n    $message = Twocheckout_Notification::check($params, \"tango\", 'array');\r\n\r\n    if ($message['code'] == 'Success') {\r\n        //Preform different actions based on the message_type\r\n        switch ($params['message_type']) {\r\n            case 'FRAUD_STATUS_CHANGED':\r\n                if ($params['fraud_status'] == 'fail') {\r\n                    //Get the user id and disable access\r\n                    $id = $params['vendor_order_id'];\r\n                    $data = array(\r\n                        'active' => 0\r\n                        );\r\n                    $this->ion_auth->update($id, $data);\r\n                }\r\n                break;\r\n            case 'RECURRING_INSTALLMENT_FAILED':\r\n                //Get the user id and disable access\r\n                $id = $params['vendor_order_id'];\r\n                $data = array(\r\n                    'active' => 0\r\n                    );\r\n                $this->ion_auth->update($id, $data);\r\n                break;\r\n            case 'RECURRING_INSTALLMENT_SUCCESS':\r\n                //Get the user id and enable access\r\n                $user = $this->ion_auth->user()->row();\r\n                $status = $user->active;\r\n                if ($status == 0) {\r\n                    $id = $params['vendor_order_id'];\r\n                        $data = array(\r\n                            'active' => 1,\r\n                            'last_billed' => time(),\r\n                            'last_invoice' => $params['invoice_id']\r\n                            );\r\n                    $this->ion_auth->update($id, $data);\r\n                }\r\n                break;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nWe grab the message parameters from the $\\_POST variable and assign each key/value pair to an array.\r\n\r\nThen we pass the array and our secret word to the `Twocheckout::Notification` binding and check the response. _(Twocheckout bindings return JSON by default or you can pass an optional third argument 'array' to return the response in an array.)_\r\n\r\nIf the response if successful `$response['code'] == \"Success\"`, we can preform actions based on the `message_type` parameter value.\r\n\r\nFor the Fraud Status Changed message, we will check the value of the `fraud_status` parameter and disable the user if it equals 'pass'.\r\nFor the Recurring Installment Failed message we will disable the user.\r\nFor the Recurring Installment Success message we will enable the user.\r\n\r\nNow we can setup our Notification URL path \"http://localhost/web-widgets/index.php/order/notification\" and enable each message under the Notifications page in our 2Checkout admin.\r\n\r\n![](http://github.com/2checkout/2checkout-ci-tutorial/raw/master/img/webwidgets-6.png)\r\n\r\nLets test our notification function. Now there are a couple ways to go about this. You can wait for the notifications to come on a live sale, or just head over to the [INS testing tool](http://developers.2checkout.com/inss) and test the messages right now. Remember the MD5 hash must match so for easy testing, you must compute the hash based on the like below:\r\n\r\n`UPPERCASE(MD5_ENCRYPTED(sale_id + vendor_id + invoice_id + Secret Word))`\r\n\r\nYou can just use an [online MD5 Hash generator](https://www.google.com/webhp?q=md5+generator) and convert it to uppercase.\r\n\r\nCancel\r\n------\r\n\r\nWe want to provide the user with the ability to cancel their membership and recurring billing without having to contact us so we already have a view setup for this. To cancel the recurring billing we will use the `Twocheckout::Sale::stop` binding to cancel all active recurring lineitems on the sale.\r\n\r\nTo accomplish this we will setup a cancel confirmation view, a cancel success page and a cancel function in our order controller.\r\n\r\n`application/views/order/cancel.php`\r\n```php\r\n<?php\r\n\r\n<?php echo form_open(\"<?php echo site_url().'/order/cancel' ?>\");?>\r\n    <input type=\"hidden\" name=\"cancel\" value=\"true\">\r\n    <p><button type=\"submit\" class=\"btn btn-primary btn-large\">Cancel Subscription</button></p>\r\n<?php echo form_close();?>\r\n```\r\n\r\n`application/views/order/cancel_success.php`\r\n```php\r\n<div class=\"container\">\r\n      <h1>Membership Canceled</h1>\r\n      <p>We have issued you a refund of $<?php echo $refund_amount; ?> for the remaining unused\r\n        <?php echo $remaining_days; ?> days of your subscription. You will recieve the credit with in 5-7 days.</p>\r\n</div>\r\n```\r\n\r\n`application/contollers/order.php`\r\n```php\r\n<?php\r\n\r\npublic function cancel()\r\n{\r\n    if ($this->input->post('cancel')) {\r\n        $user = $this->ion_auth->user()->row();\r\n        $order_number = $user->order_number;\r\n        $invoice_id = $user->last_invoice;\r\n\r\n        //Define API User and Password\r\n        Twocheckout::setCredentials(\"APIuser1817037\", \"APIpass1817037\");\r\n\r\n        //Stop recurring billing\r\n        $args = array('sale_id' => $order_number);\r\n        Twocheckout_Sale::stop($args, 'array');\r\n\r\n        //Calculate used time and refund amount\r\n        $last_bill_date = $user->last_billed;\r\n        $next_bill_date = strtotime('+1 month',$last_bill_date);\r\n        $remaining_days = floor(abs(time() - $next_bill_date)/60/60/24);\r\n        $refund_amount = round((1.00 / 30) * $remaining_days, 2);\r\n\r\n        //Refund remaining balance\r\n        $args = array(\r\n            'invoice_id' => $invoice_id,\r\n            'category' => 5,\r\n            'amount' => $refund_amount,\r\n            'currency' => 'vendor',\r\n            'comment' => 'Refunding remaining balance'\r\n            );\r\n        Twocheckout_Sale::refund($args, 'array');\r\n\r\n        //Deactivate User\r\n        $id = $user->id;\r\n        $data = array(\r\n            'active' => 0\r\n            );\r\n        $this->ion_auth->update($id, $data);\r\n        $this->ion_auth->logout();\r\n\r\n        //Reinit $data array for view\r\n        $data = array(\r\n           'remaining_days' => $remaining_days,\r\n           'refund_amount' => $refund_amount\r\n        );\r\n\r\n        $this->load->view('/include/header');\r\n        $this->load->view('/include/navblank');\r\n        $this->load->view('/order/cancel_success', $data);\r\n        $this->load->view('/include/footer');\r\n     } else {\r\n        $this->load->view('/include/header');\r\n        $this->load->view('/include/navblank');\r\n        $this->load->view('/order/cancel');\r\n        $this->load->view('/include/footer');\r\n    }\r\n}\r\n```\r\nWhen we get the cancel confirmation from the user, we get the user's order\\_number and their most recent invoice\\_id.\r\n\r\nWe then set our 2Checkout API username and password using the `Twocheckout::setCredentials()` method.\r\n\r\nNow we set the order\\_number to the 'sale\\_id' key in an array and pass the array to the `Twocheckout_Sale::stop()` method.\r\n\r\nSince we are going to disable the user, we should also go ahead and refund them for the unused days in their subscription. So we use the last\\_billed timestamp for the user to caclulate the unused days in their subscription.\r\n\r\n```php\r\n<?php\r\n\r\n$last_bill_date = $user->last_billed;\r\n$next_bill_date = strtotime('+1 month',$last_bill_date);\r\n$remaining_days = floor(abs(time() - $next_bill_date)/60/60/24);\r\n```\r\n\r\nWe can then apply that to the subscription cost to get the refund amount.\r\n\r\n```php\r\n$refund_amount = round((1.00 / 30) * $remaining_days, 2);\r\n```\r\n\r\nTo submit the refund, we setup the an array that contains the invoice\\_id from the most recent invoice, the refund amount and currency, and the comment and category.\r\n\r\n```php\r\n<?php\r\n\r\n$args = array(\r\n    'invoice_id' => $invoice_id,\r\n    'category' => 5,\r\n    'amount' => $refund_amount,\r\n    'currency' => 'vendor',\r\n    'comment' => 'Refunding remaining balance'\r\n    );\r\n\r\nTwocheckout_Sale::refund($args, 'array');\r\n```\r\n\r\nWe then disable the user and redirect them to our cancel success page.\r\n\r\n```php\r\n<?php\r\n\r\n//Deactivate User\r\n$id = $user->id;\r\n$data = array(\r\n    'active' => 0\r\n    );\r\n$this->ion_auth->update($id, $data);\r\n$this->ion_auth->logout();\r\n\r\n//Reinit $data array for view\r\n$data = array(\r\n   'remaining_days' => $remaining_days,\r\n   'refund_amount' => $refund_amount\r\n);\r\n\r\n$this->load->view('/include/header');\r\n$this->load->view('/include/navblank');\r\n$this->load->view('/order/cancel_success', $data);\r\n$this->load->view('/include/footer');\r\n```\r\n\r\nUpdate\r\n------\r\n\r\nThis last one is easy. 2Checkout provides a page for users to update their billing information on a recurring sale. We could just define the URL in our navbar. But to make it easy for them, lets pass in the order\\_number when we redirect them.\r\n\r\n`application/views/include/navbar.php`\r\n```php\r\n<?php\r\n\r\n<a href=\"<?php echo site_url().'/order/update' ?>\">Update Billing Information</a>\r\n```\r\n\r\nNow lets setup our update function.\r\n\r\n`application/contollers/order.php`\r\n```php\r\n<?php\r\n\r\npublic function update()\r\n{\r\n    $user = $this->ion_auth->user()->row();\r\n    $order_number = $user->order_number;\r\n    redirect('https://www.2checkout.com/va/sales/customer/change_billing_method?sale_id='.$order_number, 'refresh');\r\n}\r\n```\r\n\r\nConclusion\r\n----------\r\n\r\nNow our application is fully integrated! Our users can register, pay for their membership and immediatly get access. We update the user based on the 2Checkout INS messages, and we provided the user with the ability to cancel the order or update their billing information.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration.","tagline":"2Checkout CodeIgniter Example Tutorial"}